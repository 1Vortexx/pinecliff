<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinecliff County - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: #2c3e50;
        }

        /* Login Styles */
        .login-container {
            max-width: 450px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: #2c3e50;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        /* Tab Navigation */
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e1e8ed;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
            transition: all 0.3s;
            font-weight: 600;
            color: #666;
            background: #f8f9fa;
        }

        .nav-tab:hover {
            background: #e9ecef;
            color: #2c3e50;
        }

        .nav-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: white;
        }

        .nav-tab i {
            margin-right: 8px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .stat-value {
            font-size: 2.5em;
            font-weight: 700;
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 1em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        thead {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
        }

        th {
            font-weight: 600;
        }

        tbody tr {
            border-bottom: 1px solid #e1e8ed;
            transition: background 0.3s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 2px;
        }

        .btn-view {
            background: #3498db;
            color: white;
        }

        .btn-view:hover {
            background: #2980b9;
        }

        .btn-approve {
            background: #28a745;
            color: white;
        }

        .btn-approve:hover {
            background: #218838;
        }

        .btn-deny {
            background: #dc3545;
            color: white;
        }

        .btn-deny:hover {
            background: #c82333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e8ed;
        }

        .close-btn {
            font-size: 2em;
            cursor: pointer;
            color: #7f8c8d;
        }

        .close-btn:hover {
            color: #2c3e50;
        }

        /* Answer Cards */
        .answer-card {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #e1e8ed;
        }

        .answer-card.correct {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .answer-card.incorrect {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .answer-card strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 8px;
        }

        .option-list {
            margin-top: 10px;
            padding-left: 10px;
        }

        .option-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
        }

        .option-selected {
            background: #fff3cd;
            font-weight: 600;
        }

        .option-correct {
            background: #d4edda;
            font-weight: 600;
            color: #155724;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }

            .tab-content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.9em;
            }

            th,
            td {
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <div id="loginPage">
        <div class="login-container">
            <div class="login-header">
                <h2><i class="fas fa-lock"></i> Admin Login</h2>
                <p>Pinecliff County Admin Portal</p>
            </div>

            <div id="loginError" class="error"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="username" required placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="password"><i class="fas fa-key"></i> Password</label>
                    <input type="password" id="password" required placeholder="Enter password">
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>
    </div>

    <div class="container" id="dashboardPage" style="display: none;">
        <div class="header">
            <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('handbook')">
                <i class="fas fa-book"></i> Staff Handbook Quiz
            </div>
            <div class="nav-tab" onclick="switchTab('staff-app')">
                <i class="fas fa-user-tie"></i> Staff Applications
            </div>
            <div class="nav-tab" onclick="switchTab('civilian-app')">
                <i class="fas fa-users"></i> Civilian Applications
            </div>
        </div>

        <!-- HANDBOOK QUIZ TAB -->
        <div id="handbook-tab" class="tab-content active">
            <h2>Staff Handbook Quiz Responses</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3><i class="fas fa-users"></i> Total Submissions</h3>
                    <div class="stat-value" id="handbookTotal">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <h3><i class="fas fa-check-circle"></i> Passed</h3>
                    <div class="stat-value" id="handbookPassed">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);">
                    <h3><i class="fas fa-times-circle"></i> Failed</h3>
                    <div class="stat-value" id="handbookFailed">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3><i class="fas fa-percentage"></i> Average Score</h3>
                    <div class="stat-value" id="handbookAvg">0%</div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-item">
                    <label>Filter by Result</label>
                    <select id="handbookFilterResult" onchange="filterHandbook()">
                        <option value="all">All Results</option>
                        <option value="passed">Passed Only</option>
                        <option value="failed">Failed Only</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Sort By</label>
                    <select id="handbookSortBy" onchange="filterHandbook()">
                        <option value="date_desc">Newest First</option>
                        <option value="date_asc">Oldest First</option>
                        <option value="score_desc">Highest Score</option>
                        <option value="score_asc">Lowest Score</option>
                    </select>
                </div>
            </div>

            <div id="handbookLoading" class="loading">Loading...</div>

            <table id="handbookTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Discord Username</th>
                        <th>Discord ID</th>
                        <th>Score</th>
                        <th>Result</th>
                        <th>Submitted</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="handbookTableBody"></tbody>
            </table>
        </div>

        <!-- STAFF APPLICATION TAB -->
        <div id="staff-app-tab" class="tab-content">
            <h2>Staff Applications</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3><i class="fas fa-inbox"></i> Total</h3>
                    <div class="stat-value" id="staffTotal">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fbc531 0%, #e1b12c 100%);">
                    <h3><i class="fas fa-clock"></i> Pending</h3>
                    <div class="stat-value" id="staffPending">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <h3><i class="fas fa-check"></i> Accepted</h3>
                    <div class="stat-value" id="staffAccepted">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);">
                    <h3><i class="fas fa-times"></i> Denied</h3>
                    <div class="stat-value" id="staffDenied">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3><i class="fas fa-percentage"></i> Avg Score</h3>
                    <div class="stat-value" id="staffAvg">0%</div>
                </div>
            </div>

            <div id="staffLoading" class="loading">Loading...</div>

            <table id="staffTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Discord</th>
                        <th>Score</th>
                        <th>Result</th>
                        <th>Status</th>
                        <th>Submitted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="staffTableBody"></tbody>
            </table>
        </div>

        <!-- CIVILIAN APPLICATION TAB -->
        <div id="civilian-app-tab" class="tab-content">
            <h2>Civilian Applications</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3><i class="fas fa-inbox"></i> Total</h3>
                    <div class="stat-value" id="civilianTotal">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fbc531 0%, #e1b12c 100%);">
                    <h3><i class="fas fa-clock"></i> Pending</h3>
                    <div class="stat-value" id="civilianPending">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <h3><i class="fas fa-check"></i> Approved</h3>
                    <div class="stat-value" id="civilianApproved">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);">
                    <h3><i class="fas fa-times"></i> Denied</h3>
                    <div class="stat-value" id="civilianDenied">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3><i class="fas fa-percentage"></i> Avg Score</h3>
                    <div class="stat-value" id="civilianAvg">0%</div>
                </div>
            </div>

            <div id="civilianLoading" class="loading">Loading...</div>

            <table id="civilianTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Discord</th>
                        <th>Score</th>
                        <th>Result</th>
                        <th>Status</th>
                        <th>Submitted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="civilianTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- MODAL -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Details</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://kyrwsuhcljhetjeavrjm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5cndzdWhjbGpoZXRqZWF2cmptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NDkyNjMsImV4cCI6MjA3OTMyNTI2M30.JBFSA-cVMV6bKcj86buLqAH7-d_IuwDqrjbJAcJfIA0';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        let handbookData = [];
        let staffAppData = [];
        let civilianAppData = [];

        function checkLogin() {
            const user = sessionStorage.getItem('pinecliff_admin');
            if (user) {
                currentUser = JSON.parse(user);
                showDashboard();
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            loginError.style.display = 'none';

            try {
                const { data, error } = await supabaseClient
                    .from('logins')
                    .select('*')
                    .eq('username', document.getElementById('username').value)
                    .eq('password_hash', document.getElementById('password').value)
                    .single();

                if (error || !data) throw new Error('Invalid credentials');

                await supabaseClient.from('logins').update({ last_login: new Date().toISOString() }).eq('id', data.id);

                currentUser = data;
                sessionStorage.setItem('pinecliff_admin', JSON.stringify(data));
                showDashboard();
            } catch (error) {
                loginError.textContent = error.message;
                loginError.style.display = 'block';
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
            }
        });

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'block';
            loadHandbook();
            loadStaffApp();
            loadCivilianApp();
        }

        function logout() {
            sessionStorage.removeItem('pinecliff_admin');
            location.reload();
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.closest('.nav-tab').classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }

        // HANDBOOK QUIZ FUNCTIONS
        async function loadHandbook() {
            try {
                const { data, error } = await supabaseClient
                    .from('responses')
                    .select('*')
                    .order('submitted_at', { ascending: false });

                if (error) throw error;

                handbookData = data || [];
                const total = handbookData.length;
                const passed = handbookData.filter(r => r.passed).length;
                const avg = total > 0 ? (handbookData.reduce((sum, r) => sum + parseFloat(r.score_percentage), 0) / total).toFixed(1) : 0;

                document.getElementById('handbookTotal').textContent = total;
                document.getElementById('handbookPassed').textContent = passed;
                document.getElementById('handbookFailed').textContent = total - passed;
                document.getElementById('handbookAvg').textContent = avg + '%';

                filterHandbook();
                document.getElementById('handbookLoading').style.display = 'none';
                document.getElementById('handbookTable').style.display = 'table';
            } catch (error) {
                console.error('Error loading handbook:', error);
            }
        }

        function filterHandbook() {
            const filterResult = document.getElementById('handbookFilterResult').value;
            const sortBy = document.getElementById('handbookSortBy').value;
            let filtered = [...handbookData];

            if (filterResult === 'passed') filtered = filtered.filter(r => r.passed);
            else if (filterResult === 'failed') filtered = filtered.filter(r => !r.passed);

            if (sortBy === 'date_asc') filtered.sort((a, b) => new Date(a.submitted_at) - new Date(b.submitted_at));
            else if (sortBy === 'date_desc') filtered.sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at));
            else if (sortBy === 'score_asc') filtered.sort((a, b) => parseFloat(a.score_percentage) - parseFloat(b.score_percentage));
            else if (sortBy === 'score_desc') filtered.sort((a, b) => parseFloat(b.score_percentage) - parseFloat(a.score_percentage));

            displayHandbook(filtered);
        }

        function displayHandbook(data) {
            const tbody = document.getElementById('handbookTableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #7f8c8d;">No responses found</td></tr>';
                return;
            }

            data.forEach(response => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${escapeHtml(response.respondent_name)}</strong></td>
                    <td>${escapeHtml(response.respondent_email || 'N/A')}</td>
                    <td><strong>${response.score_percentage}%</strong> (${response.correct_answers}/${response.total_questions})</td>
                    <td><span class="badge ${response.passed ? 'badge-success' : 'badge-danger'}">${response.passed ? '✓ Passed' : '✗ Failed'}</span></td>
                    <td>${new Date(response.submitted_at).toLocaleString()}</td>
                    <td><button class="btn-small btn-view" onclick='viewHandbook(${JSON.stringify(response).replace(/'/g, "&#39;")})'><i class="fas fa-eye"></i> View</button></td>
                `;
            });
        }

        function viewHandbook(response) {
            document.getElementById('modalTitle').textContent = 'Quiz Results: ' + response.respondent_name;
            let html = `
                <p><strong>Score:</strong> ${response.score_percentage}% (${response.correct_answers}/${response.total_questions})</p>
                <p><strong>Result:</strong> <span class="badge ${response.passed ? 'badge-success' : 'badge-danger'}">${response.passed ? 'PASSED' : 'FAILED'}</span></p>
                <hr style="margin: 20px 0;">
                <h3>Answers:</h3>
            `;

            for (const [qNum, answer] of Object.entries(response.answers)) {
                html += `<div class="answer-card ${answer.isCorrect ? 'correct' : 'incorrect'}">`;
                html += `<strong>Q${qNum}: ${escapeHtml(answer.question)}</strong>`;
                html += answer.isCorrect ? '<span style="color: #28a745; float: right;">✓ CORRECT</span>' : '<span style="color: #dc3545; float: right;">✗ WRONG</span>';
                html += '<div class="option-list">';
                
                ['A', 'B', 'C', 'D'].forEach(letter => {
                    const optionKey = 'option_' + letter.toLowerCase();
                    if (answer[optionKey]) {
                        const isSelected = answer.selected === letter;
                        const isCorrect = answer.correct === letter;
                        const className = isCorrect ? 'option-correct' : (isSelected ? 'option-selected' : '');
                        html += `<div class="option-item ${className}">${letter}) ${escapeHtml(answer[optionKey])} ${isSelected ? '← Your Answer' : ''} ${isCorrect ? '✓' : ''}</div>`;
                    }
                });
                
                html += '</div></div>';
            }

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailsModal').style.display = 'block';
        }

        // STAFF APPLICATION FUNCTIONS
        async function loadStaffApp() {
            try {
                const { data, error } = await supabaseClient
                    .from('staff_responses')
                    .select('*')
                    .order('submitted_at', { ascending: false });

                if (error) throw error;

                staffAppData = data || [];
                const total = staffAppData.length;
                const pending = staffAppData.filter(a => a.status === 'pending').length;
                const accepted = staffAppData.filter(a => a.status === 'accepted').length;
                const denied = staffAppData.filter(a => a.status === 'denied').length;
                const avg = total > 0 ? (staffAppData.reduce((sum, a) => sum + parseFloat(a.score_percentage), 0) / total).toFixed(1) : 0;

                document.getElementById('staffTotal').textContent = total;
                document.getElementById('staffPending').textContent = pending;
                document.getElementById('staffAccepted').textContent = accepted;
                document.getElementById('staffDenied').textContent = denied;
                document.getElementById('staffAvg').textContent = avg + '%';

                displayStaffApp();
                document.getElementById('staffLoading').style.display = 'none';
                document.getElementById('staffTable').style.display = 'table';
            } catch (error) {
                console.error('Error loading staff apps:', error);
            }
        }

        function displayStaffApp() {
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = '';

            if (staffAppData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #7f8c8d;">No applications found</td></tr>';
                return;
            }

            staffAppData.forEach(app => {
                const statusClass = app.status === 'accepted' ? 'badge-success' : app.status === 'denied' ? 'badge-danger' : 'badge-warning';
                const passClass = app.passed ? 'badge-success' : 'badge-danger';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${escapeHtml(app.discord_username)}</strong></td>
                    <td><strong>${app.score_percentage}%</strong> (${app.correct_answers}/${app.total_questions})</td>
                    <td><span class="badge ${passClass}">${app.passed ? 'Passed' : 'Failed'}</span></td>
                    <td><span class="badge ${statusClass}">${app.status.toUpperCase()}</span></td>
                    <td>${new Date(app.submitted_at).toLocaleString()}</td>
                    <td>
                        <button class="btn-small btn-view" onclick='viewStaffApp(${JSON.stringify(app).replace(/'/g, "&#39;")})'><i class="fas fa-eye"></i> View</button>
                        ${app.status === 'pending' ? `
                            <button class="btn-small btn-approve" onclick="updateAppStatus('${app.id}', 'accepted')"><i class="fas fa-check"></i> Accept</button>
                            <button class="btn-small btn-deny" onclick="updateAppStatus('${app.id}', 'denied')"><i class="fas fa-times"></i> Deny</button>
                        ` : ''}
                    </td>
                `;
            });
        }

        function viewStaffApp(app) {
            document.getElementById('modalTitle').textContent = 'Application: ' + app.discord_username;
            let html = `
                <p><strong>Discord:</strong> ${escapeHtml(app.discord_username)}</p>
                <p><strong>Steam:</strong> ${escapeHtml(app.steam_username || 'N/A')}</p>
                <p><strong>Score:</strong> ${app.score_percentage}% (${app.correct_answers}/${app.total_questions})</p>
                <p><strong>Result:</strong> <span class="badge ${app.passed ? 'badge-success' : 'badge-danger'}">${app.passed ? 'PASSED' : 'FAILED'}</span></p>
                <p><strong>Status:</strong> <span class="badge ${app.status === 'accepted' ? 'badge-success' : app.status === 'denied' ? 'badge-danger' : 'badge-warning'}">${app.status.toUpperCase()}</span></p>
                <hr style="margin: 20px 0;">
                <h3>Answers:</h3>
            `;

            const sortedAnswers = Object.entries(app.answers).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            for (const [qNum, answer] of sortedAnswers) {
                html += `<div class="answer-card ${answer.isCorrect ? 'correct' : 'incorrect'}">`;
                html += `<strong>Q${qNum}: ${escapeHtml(answer.question)}</strong>`;
                html += answer.isCorrect ? '<span style="color: #28a745; float: right;">✓ CORRECT</span>' : '<span style="color: #dc3545; float: right;">✗ WRONG</span>';
                html += '<div class="option-list">';
                
                ['A', 'B', 'C', 'D'].forEach(letter => {
                    const optionKey = 'option_' + letter.toLowerCase();
                    if (answer[optionKey]) {
                        const isSelected = answer.selected === letter;
                        const isCorrect = answer.correct === letter;
                        const className = isCorrect ? 'option-correct' : (isSelected ? 'option-selected' : '');
                        html += `<div class="option-item ${className}">${letter}) ${escapeHtml(answer[optionKey])} ${isSelected ? '← Your Answer' : ''} ${isCorrect ? '✓' : ''}</div>`;
                    }
                });
                
                html += '</div></div>';
            }

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailsModal').style.display = 'block';
        }

        async function updateAppStatus(id, status) {
            if (!confirm(`Are you sure you want to ${status} this application?`)) return;

            try {
                const { error } = await supabaseClient
                    .from('staff_responses')
                    .update({
                        status: status,
                        reviewed_by: currentUser.username,
                        reviewed_at: new Date().toISOString()
                    })
                    .eq('id', id);

                if (error) throw error;
                alert('Status updated!');
                loadStaffApp();
                closeModal();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.id === 'detailsModal') closeModal();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // CIVILIAN APPLICATION FUNCTIONS
        async function loadCivilianApp() {
            try {
                const { data, error } = await supabaseClient
                    .from('civilian_responses')
                    .select('*')
                    .order('submitted_at', { ascending: false });

                if (error) throw error;

                civilianAppData = data || [];
                const total = civilianAppData.length;
                const pending = civilianAppData.filter(a => a.status === 'pending').length;
                const approved = civilianAppData.filter(a => a.status === 'approved').length;
                const denied = civilianAppData.filter(a => a.status === 'denied').length;
                const avg = total > 0 ? (civilianAppData.reduce((sum, a) => sum + parseFloat(a.score_percentage), 0) / total).toFixed(1) : 0;

                document.getElementById('civilianTotal').textContent = total;
                document.getElementById('civilianPending').textContent = pending;
                document.getElementById('civilianApproved').textContent = approved;
                document.getElementById('civilianDenied').textContent = denied;
                document.getElementById('civilianAvg').textContent = avg + '%';

                displayCivilianApp();
                document.getElementById('civilianLoading').style.display = 'none';
                document.getElementById('civilianTable').style.display = 'table';
            } catch (error) {
                console.error('Error loading civilian apps:', error);
            }
        }

        function displayCivilianApp() {
            const tbody = document.getElementById('civilianTableBody');
            tbody.innerHTML = '';

            if (civilianAppData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #7f8c8d;">No applications found</td></tr>';
                return;
            }

            civilianAppData.forEach(app => {
                const statusClass = app.status === 'approved' ? 'badge-success' : app.status === 'denied' ? 'badge-danger' : 'badge-warning';
                const passClass = app.passed ? 'badge-success' : 'badge-danger';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${escapeHtml(app.full_name)}</strong></td>
                    <td>${escapeHtml(app.discord_username)}</td>
                    <td><strong>${app.score_percentage}%</strong> (${app.correct_answers}/${app.total_questions})</td>
                    <td><span class="badge ${passClass}">${app.passed ? 'Passed' : 'Failed'}</span></td>
                    <td><span class="badge ${statusClass}">${app.status.toUpperCase()}</span></td>
                    <td>${new Date(app.submitted_at).toLocaleString()}</td>
                    <td>
                        <button class="btn-small btn-view" onclick='viewCivilianApp(${JSON.stringify(app).replace(/'/g, "&#39;")})'><i class="fas fa-eye"></i> View</button>
                        ${app.status === 'pending' ? `
                            <button class="btn-small btn-approve" onclick="updateCivilianStatus('${app.id}', 'approved')"><i class="fas fa-check"></i> Approve</button>
                            <button class="btn-small btn-deny" onclick="updateCivilianStatus('${app.id}', 'denied')"><i class="fas fa-times"></i> Deny</button>
                        ` : ''}
                    </td>
                `;
            });
        }

        function viewCivilianApp(app) {
            document.getElementById('modalTitle').textContent = 'Civilian Application: ' + app.full_name;
            let html = `
                <div style="margin-bottom: 20px;">
                    <p><strong>Full Name:</strong> ${escapeHtml(app.full_name)}</p>
                    <p><strong>Discord:</strong> ${escapeHtml(app.discord_username)}</p>
                    <p><strong>Steam:</strong> ${escapeHtml(app.steam_username)}</p>
                    <p><strong>Score:</strong> ${app.score_percentage}% (${app.correct_answers}/${app.total_questions})</p>
                    <p><strong>Result:</strong> <span class="badge ${app.passed ? 'badge-success' : 'badge-danger'}">${app.passed ? 'PASSED' : 'FAILED'}</span></p>
                    <p><strong>Status:</strong> <span class="badge ${app.status === 'approved' ? 'badge-success' : app.status === 'denied' ? 'badge-danger' : 'badge-warning'}">${app.status.toUpperCase()}</span></p>
                    <p><strong>Submitted:</strong> ${new Date(app.submitted_at).toLocaleString()}</p>
                </div>
                <hr style="margin: 20px 0;">
                <h3>Answers (Color Coded):</h3>
            `;

            const sortedAnswers = Object.entries(app.answers).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            for (const [qNum, answer] of sortedAnswers) {
                html += `<div class="answer-card ${answer.isCorrect ? 'correct' : 'incorrect'}">`;
                html += `<strong>Q${qNum}: ${escapeHtml(answer.question)}</strong>`;
                html += answer.isCorrect ? '<span style="color: #28a745; float: right;">✓ CORRECT</span>' : '<span style="color: #dc3545; float: right;">✗ WRONG</span>';
                html += '<div class="option-list">';
                
                ['A', 'B', 'C', 'D'].forEach(letter => {
                    const optionKey = 'option_' + letter.toLowerCase();
                    if (answer[optionKey]) {
                        const isSelected = answer.selected === letter;
                        const isCorrect = answer.correct === letter;
                        const className = isCorrect ? 'option-correct' : (isSelected ? 'option-selected' : '');
                        html += `<div class="option-item ${className}">${letter}) ${escapeHtml(answer[optionKey])} ${isSelected ? '← Your Answer' : ''} ${isCorrect ? '✓' : ''}</div>`;
                    }
                });
                
                html += '</div></div>';
            }

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailsModal').style.display = 'block';
        }

        async function updateCivilianStatus(id, status) {
            if (!confirm(`Are you sure you want to ${status} this application?`)) return;

            try {
                const { error } = await supabaseClient
                    .from('civilian_responses')
                    .update({
                        status: status,
                        reviewed_by: currentUser.username,
                        reviewed_at: new Date().toISOString()
                    })
                    .eq('id', id);

                if (error) throw error;
                alert('Status updated!');
                loadCivilianApp();
                closeModal();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        checkLogin();
    </script>
</body>
</html>
